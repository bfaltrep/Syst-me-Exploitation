#ifdef CHANGED
#include "pageprovider.h"
#include "system.h"

PageProvider::PageProvider(int nitems, Machine * m)
{
	map = new BitMap(nitems);
	_machine = m;
}

PageProvider::~PageProvider()
{
	delete map;
}

int PageProvider::GetEmptyPage()
{
	int pos = 1;
	int val;

	if(map->NumClear() == 0){
		return -1;
	}
	do{
		val = random()%NumPhysPages;
		pos = map->Test(val);
		DEBUG ('c', "\npageprovider->getEmptyPage : %d et %d\n",pos,val);
	}while(pos != 0);

	if(val != -1){
		int physAddr = val* PageSize;
		memset( &machine->mainMemory[physAddr],'\0',PageSize);
	}
	DEBUG ('b', "\npageprovider->getEmptyPage : %d\n",val);
	return val;
	/*
	int res = map->Find();
	if(res != -1){
		int physAddr = res* PageSize;
		memset( &machine->mainMemory[physAddr],'\0',PageSize);
	}

	DEBUG ('b', "\npageprovider->getEmptyPage : %d\n",res);
	return res;*/
}

void PageProvider::ReleasePage(int page)
{
	DEBUG ('b', "\npageprovider->ReleasePage : %d\n",page);
	map->Clear(page);

}

int	PageProvider::NumAvailablePage()
{
	return map->NumClear ();
}

#endif // CHANGED