
#include "userthread.h"
//pour avoir un nom unique par thread, on incrÃ©mente la variable.
int name ;

int do_ThreadCreate (int f, int arg){
	
	Thread res = new Thread("test");
	name++;
	int fonction[2] = {f,arg};
	res->Start(StartUserThread, fonction);

	if (false)
	{
		return -1;
	}

	return 0;
}


void StartUserThread(void * schmurtz){
	// DEBUG('x', "mon debug %d\n", mavar);
	DEBUG('x', "StartUserThread with function : %d and argument %d\n", (int)*schmurtz, (int)*schmurtz+1);
	int i;
 	for (i = 0; i < NumTotalRegs; i++){
		machine->WriteRegister (i, 0);
	}
	machine->WriteRegister (PCReg, USER_START_ADDRESS);
	machine->WriteRegister (NextPCReg, machine->ReadRegister(PCReg) + 4);

    machine->WriteRegister(4, schmurtz[0]);
	DEBUG('x', "Register 4 : %d\n", machine->ReadRegister(4));
	machine->WriteRegister(5, schmurtz[1]);
	DEBUG('x', "Register 5 : %d\n", machine->ReadRegister(5));
    machine->Run();	
    
}